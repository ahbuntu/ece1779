{% extends "base.html" %}

{% block style_block %}
    <style type="text/css">
        table.table { width: 60%; }
    </style>
{% endblock %}

{% block content %}

    <h1 id="">Welcome {{ user }}</h1>
    <div>&nbsp;</div>

    {% if prospective_user is none %}
        <h3>Current location</h3>
        <div>Your home location is not set.</div>
        <div id="map-canvas-profile"></div>
        <p>
            <form id="post-user-form" method="post" action="{{ url_for('user_profile') }}">
                <div class="control-group">
                    <div class="control-label">Coordinates of marker</div>
                    <div class="controls">
                        <input id="origin_location" name="origin_location" type="text"/>
                    </div>
                    <div class="control-label">Notification radius (km)</div>
                    <div class="controls">
                        <input id="notification_radius_in_km" name="notification_radius_in_km" type="number" value="100"/>
                    </div>
                </div>
                <div>&nbsp;</div>
                <button class="btn btn-default">Set as home location</button>
            </form>
            <div>Click the button to receive notifications for new questions near you.</div>
        </p>
    {% else %}
        <h3>Home location</h3>
        <div>Drag the marker to select a new location.</div>
        <div id="map-canvas-profile"></div>
        <p>
            <form id="post-user-form" method="post" action="{{ url_for('user_profile') }}">
                <div class="control-group">
                    <div class="control-label">Coordinates of marker</div>
                    <div class="controls">
                        <input id="origin_location" name="origin_location" type="text"/>
                    </div>
                    <div class="control-label">Notification radius (km)</div>
                    <div class="controls">
                        <input id="notification_radius_in_km" name="notification_radius_in_km" type="number" value="100"/>
                    </div>
                </div>
                <div>&nbsp;</div>
                <button class="btn btn-default">Update</button>
            </form>
        </p>
    {% endif %}

    <div>&nbsp;</div>
    <h3>Recent Activity</h3>
    <div>&nbsp;</div>

    <h4><a href="{{ url_for('list_questions_for_user') }}">{{ question_count }}</a> questions asked.</h4>
    <h4>{{ answer_count }} answers provided.</h4>
    <div>&nbsp;</div>

{% endblock content %}

{% block tail_script %}
    <script src="https://maps.googleapis.com/maps/api/js">
    </script>
    <script>
        function displayonmap(homeLatLng) {
            var mapCanvas = document.getElementById('map-canvas-profile');
            var mapOptions = {
              center: homeLatLng,
              zoom: 13,
              mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            var map = new google.maps.Map(mapCanvas, mapOptions);
            // To add the marker to the map, use the 'map' property
            var marker = new google.maps.Marker({
                position: homeLatLng,
                map: map,
                draggable: true,
                title:"Me"
            });

            google.maps.event.addListener(marker, 'dragstart', function() {
                $('#origin_location').val("");
            });

            google.maps.event.addListener(marker, 'dragend', function() {
                $('#origin_location').val(marker.getPosition().toUrlValue());
            });
        }

        function geosuccess(position) {
            displayonmap(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
            $('#origin_location').val(position.coords.latitude + "," +position.coords.longitude);
        }
        function geoerror(msg) {
            alert(msg);
        }
        function getgeolocation() {
            {% if prospective_user is none %}
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(geosuccess, geoerror);
                } else {
                    alert('Geolocation not supported');
                }
            {% else %}
                displayonmap(new google.maps.LatLng( {{ prospective_user.origin_location.lat }},{{ prospective_user.origin_location.lon }} ));
                $('#origin_location').val({{ prospective_user.origin_location.lat }} + "," + {{ prospective_user.origin_location.lon }});
            {% endif %}
        }

        var FormHelpers = {
            init: function () {
                var self = this;
                var location_form = $('#post-user-form');
                location_form.on('submit', function (evt) {
                    //alert($('#origin_location').val());
                });
            }
        };
        $(document).ready(function() {
            getgeolocation();
            FormHelpers.init();
        });
    </script>

{% endblock tail_script %}